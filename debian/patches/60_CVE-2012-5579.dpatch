#! /bin/sh /usr/share/dpatch/dpatch-run
## 60_CVE-2012-5517.dpatch by Clint Byrum <clint@ubuntu.com>
##
## All lines beginning with `## DP:' are a description of the patch.

@DPATCH@

Origin: http://bazaar.launchpad.net/~maria-captains/maria/5.3/revision/2643.153.26
Description: Fixes CVE-2012-5517 as fixed in MariaDB. Slight changes to apply
 on stock MySQL.

diff -ur old/mysql-test/r/information_schema.result new/mysql-test/r/information_schema.result
--- old/mysql-test/r/information_schema.result	2012-09-07 14:24:44.000000000 +0000
+++ new/mysql-test/r/information_schema.result	2012-11-29 05:16:37.459724809 +0000
@@ -1774,4 +1774,10 @@
 length(CAST(b AS CHAR))
 20
 DROP TABLE ubig;
+select 1 from information_schema.tables where table_schema=repeat('a', 2000);
+1
+grant usage on *.* to mysqltest_1@localhost;
+select 1 from information_schema.tables where table_schema=repeat('a', 2000);
+1
+drop user mysqltest_1@localhost;
 End of 5.1 tests.
diff -ur old/mysql-test/t/information_schema.test new/mysql-test/t/information_schema.test
--- old/mysql-test/t/information_schema.test	2012-09-07 14:24:41.000000000 +0000
+++ new/mysql-test/t/information_schema.test	2012-11-29 05:16:07.183724770 +0000
@@ -1470,6 +1470,17 @@
 
 DROP TABLE ubig;
 
+#
+# Bug #13889741: HANDLE_FATAL_SIGNAL IN _DB_ENTER_ | HANDLE_FATAL_SIGNAL IN STRNLEN
+#
+select 1 from information_schema.tables where table_schema=repeat('a', 2000);
+grant usage on *.* to mysqltest_1@localhost;
+connect (con1, localhost, mysqltest_1,,);
+connection con1;
+select 1 from information_schema.tables where table_schema=repeat('a', 2000);
+connection default;
+disconnect con1;
+drop user mysqltest_1@localhost;
 
 --echo End of 5.1 tests.
 
diff -ur old/sql/sql_acl.cc new/sql/sql_acl.cc
--- old/sql/sql_acl.cc	2012-11-28 23:18:29.675724716 +0000
+++ new/sql/sql_acl.cc	2012-11-28 23:03:27.219724713 +0000
@@ -1351,14 +1351,20 @@
   acl_entry *entry;
   DBUG_ENTER("acl_get");
 
-  VOID(pthread_mutex_lock(&acl_cache->lock));
-  end=strmov((tmp_db=strmov(strmov(key, ip ? ip : "")+1,user)+1),db);
+  tmp_db= strmov(strmov(key, ip ? ip : "") + 1, user) + 1;
+  end= strnmov(tmp_db, db, key + sizeof(key) - tmp_db);
+
+  if (end >= key + sizeof(key)) // db name was truncated
+    DBUG_RETURN(0);             // no privileges for an invalid db name
+
   if (lower_case_table_names)
   {
     my_casedn_str(files_charset_info, tmp_db);
     db=tmp_db;
   }
   key_length= (size_t) (end-key);
+
+  VOID(pthread_mutex_lock(&acl_cache->lock));
   if (!db_is_pattern && (entry=(acl_entry*) acl_cache->search((uchar*) key,
                                                               key_length)))
   {
@@ -4327,11 +4333,17 @@
 bool check_grant_db(THD *thd,const char *db)
 {
   Security_context *sctx= thd->security_ctx;
-  char helping [NAME_LEN+USERNAME_LENGTH+2];
+  char helping [NAME_LEN + USERNAME_LENGTH+2], *end;
   uint len;
   bool error= TRUE;
 
-  len= (uint) (strmov(strmov(helping, sctx->priv_user) + 1, db) - helping) + 1;
+  end= strmov(helping, sctx->priv_user) + 1;
+  end= strnmov(end, db, helping + sizeof(helping) - end);
+
+  if (end >= helping + sizeof(helping)) // db name was truncated
+    return 1;                           // no privileges for an invalid db name
+
+  len= (uint) (end - helping) + 1;
 
   rw_rdlock(&LOCK_grant);
 
